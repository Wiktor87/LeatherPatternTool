<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Leather Pattern Tool - Pre-Apha V0.2</title>
<script src="https://cdn.jsdelivr.net/npm/clipper-lib@6.4.2/clipper.js"></script>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<!-- Left Toolbar -->
<div id="toolbar">
<button class="tool-btn active" id="tool-select" onclick="app.setMode('select')" title="Select (V)"><span class="icon">â†–</span><span>Select</span></button>
<div class="tool-sep"></div>
<button class="tool-btn" id="tool-hole" onclick="app.setMode('hole')" title="Add Hole (H)"><span class="icon">â—‹</span><span>Hole</span></button>
<button class="tool-btn" id="tool-customhole" onclick="app.setMode('customhole')" title="Custom Hole"><span class="icon">âœ</span><span>Custom</span></button>
<button class="tool-btn" id="tool-stitch" onclick="app.setMode('stitch')" title="Stitch Line (S)"><span class="icon">â”…</span><span>Stitch</span></button>
<button class="tool-btn" id="tool-shape" onclick="app.setMode('shape')" title="Shape"><span class="icon">â—‡</span><span>Shape</span></button>
<button class="tool-btn" id="tool-text" onclick="app.setMode('text')" title="Add Text (T)"><span class="icon">T</span><span>Text</span></button>
<div class="tool-sep"></div>
<button class="tool-btn" onclick="app.generateMatchingCircle()" title="Circle from Edge"><span class="icon">â—</span><span>Circle</span></button>
<button class="tool-btn" onclick="app.addEdgeRange()" title="Add Edge Range (symmetric)"><span class="icon">âŠ¢</span><span>Edge</span></button>
<button class="tool-btn" onclick="app.addMergedEdgeRange()" title="Add Full Perimeter Range"><span class="icon">âŠ¡</span><span>Perim</span></button>
<div style="flex:1"></div>
<button class="tool-btn" onclick="app.resetView()" title="Reset View"><span class="icon">âŠ™</span><span>Reset</span></button>
</div>

<!-- Top Header -->
<div id="header">
<span class="title" id="project-title" onclick="app.renameProject()" title="Click to rename">Leather Pattern</span>
<div id="layer-toggle">
<button class="layer-btn sym active" onclick="app.setLayer('symmetric')">Mirrored</button>
<button class="layer-btn asym" onclick="app.setLayer('asymmetric')">Single</button>
</div>
<div id="two-layer-toggle" style="display:none">
<button class="layer-btn front active" onclick="app.switchLayer('front')">Front</button>
<button class="layer-btn back" onclick="app.switchLayer('back')">Back</button>
</div>
<span class="spacer"></span>
<div id="two-layer-actions" style="display:none;gap:8px;">
<button class="hdr-btn secondary" onclick="app.duplicateLayer('toBack')" title="Duplicate Front to Back">Copy to Back</button>
<button class="hdr-btn secondary" onclick="app.duplicateLayer('toFront')" title="Duplicate Back to Front">Copy to Front</button>
</div>
<button class="hdr-btn secondary" onclick="app.selectHolster()">Select Pattern</button>
<button class="hdr-btn secondary" onclick="app.toggleFileMenu()">ğŸ’¾ File</button>
<button class="hdr-btn primary" onclick="app.togglePublish()">ğŸ“ Publish</button>
</div>

<!-- File Menu Dropdown -->
<div id="file-menu">
<button onclick="app.saveProject()">ğŸ’¾ Save Project</button>
<button onclick="app.loadProject()">ğŸ“‚ Open Project</button>
<input type="file" id="file-input" accept=".json" style="display:none" onchange="app.handleFileLoad(event)">
</div>

<!-- Mode Indicator -->
<div id="mode-indicator"><span class="mode-text">Mode</span><button class="mode-btn" onclick="app.finishMode()">âœ“</button><button class="mode-btn" onclick="app.cancelMode()">âœ•</button></div>

<!-- Settings Button -->
<div id="settings-btn" onclick="app.toggleSettings()">âš™</div>

<!-- Outliner Button -->
<div id="outliner-btn" onclick="app.toggleOutliner()">â˜°</div>

<!-- Outliner Panel -->
<div id="outliner-panel">
<span class="panel-title">Outliner</span>
<button class="close-btn" onclick="app.toggleOutliner()">âœ•</button>
<div id="outliner-content"></div>
</div>

<!-- Settings Overlay (click to close) -->
<div id="settings-overlay" onclick="app.toggleSettings()"></div>

<!-- Settings Panel -->
<div id="settings-panel">
<button class="close-btn" onclick="app.toggleSettings()">âœ•</button>
<div class="settings-section"><h3>Project</h3>
<div class="setting-row"><label>Type</label><select id="cfg-projectType" onchange="app.updateCfg('projectType',this.value)"><option value="fold-over">Fold-Over</option><option value="two-layer">Two-Layer</option></select></div>
</div>
<div class="settings-section" id="two-layer-sync" style="display:none"><h3>Layer Sync</h3>
<div class="setting-row"><label>Asymmetric Outline</label><input type="checkbox" id="cfg-asymmetricOutline" onchange="app.updateCfg('asymmetricOutline',this.checked)"></div>
<div class="setting-row"><label>Sync Outline</label><input type="checkbox" id="cfg-syncOutline" checked onchange="app.updateCfg('syncOutline',this.checked)"></div>
<div class="setting-row"><label>Sync Edge Stitches</label><input type="checkbox" id="cfg-syncEdgeStitches" checked onchange="app.updateCfg('syncEdgeStitches',this.checked)"></div>
<div class="setting-row"><button style="flex:1;padding:6px;background:#444;border:1px solid #555;color:#fff;border-radius:4px;cursor:pointer;font-size:11px" onclick="app.resetToMaster()">â†» Reset Back to Master</button></div>
</div>
<div class="settings-section" id="two-layer-ghost" style="display:none"><h3>Two-Layer Display</h3>
<div class="setting-row"><label>Show Other Layer</label><input type="checkbox" id="cfg-showGhostLayer" checked onchange="app.updateCfg('showGhostLayer',this.checked)"></div>
<div class="setting-row"><label>Ghost Opacity</label><input type="range" id="cfg-ghostOpacity" value="0.25" min="0.1" max="0.5" step="0.05" oninput="document.getElementById('cfg-ghostOpacity-val').textContent=this.value;app.updateCfg('ghostLayerOpacity',parseFloat(this.value))"><span id="cfg-ghostOpacity-val" style="color:#888;font-size:10px;min-width:35px;text-align:right">0.25</span></div>
<div class="setting-row"><button style="flex:1;padding:6px;background:#444;border:1px solid #555;color:#fff;border-radius:4px;cursor:pointer;font-size:11px" onclick="app.resetGhostPosition()">âŸ² Reset Ghost Position</button></div>
</div>
<div class="settings-section"><h3>Material</h3>
<div class="setting-row"><label>Thickness</label><input type="number" id="cfg-thickness" value="3" min="1.5" max="8" step="0.5" onchange="app.updateCfg('thickness',this.value)"></div>
<div class="setting-row"><label>Color</label><input type="color" id="cfg-color" value="#b4783c" onchange="app.updateCfg('leatherColor',this.value)"></div>
</div>
<div class="settings-section"><h3>Stitch Defaults</h3>
<div class="setting-row"><label>Margin</label><input type="number" id="cfg-margin" value="5" min="3" max="15" step="0.5" onchange="app.updateCfg('stitchMargin',this.value)"></div>
<div class="setting-row"><label>Spacing</label><input type="number" id="cfg-spacing" value="4" min="2" max="8" step="0.5" onchange="app.updateCfg('stitchSpacing',this.value)"></div>
<div class="setting-row"><label>Hole Size</label><input type="number" id="cfg-holeSize" value="1.5" min="0.8" max="3" step="0.1" onchange="app.updateCfg('holeSize',this.value)"></div>
<div class="setting-row"><label>Mirror</label><input type="checkbox" id="cfg-mirror" checked onchange="app.updateCfg('mirrorEdgeStitches',this.checked)"></div>
</div>
<div class="settings-section"><h3>Hole Defaults</h3>
<div class="setting-row"><label>Shape</label><select id="cfg-defShape" onchange="app.updateCfg('defaultHoleShape',this.value)"><option value="circle">Circle</option><option value="ellipse">Ellipse</option><option value="pill">Pill</option><option value="rectangle">Rectangle</option></select></div>
<div class="setting-row"><label>Width</label><input type="range" id="cfg-defW-slider" value="4" min="2" max="30" step="0.5" oninput="document.getElementById('cfg-defW').value=this.value;app.updateCfg('defaultHoleWidth',this.value)"><input type="number" id="cfg-defW" value="4" min="2" max="30" step="0.5" onchange="document.getElementById('cfg-defW-slider').value=this.value;app.updateCfg('defaultHoleWidth',this.value)"></div>
<div class="setting-row"><label>Height</label><input type="range" id="cfg-defH-slider" value="4" min="2" max="30" step="0.5" oninput="document.getElementById('cfg-defH').value=this.value;app.updateCfg('defaultHoleHeight',this.value)"><input type="number" id="cfg-defH" value="4" min="2" max="30" step="0.5" onchange="document.getElementById('cfg-defH-slider').value=this.value;app.updateCfg('defaultHoleHeight',this.value)"></div>
</div>
<div class="settings-section"><h3>Display</h3>
<div class="setting-row"><label>Cavity</label><input type="checkbox" id="cfg-cavity" checked onchange="app.updateCfg('showCavity',this.checked)"></div>
<div class="setting-row"><label>Fold Line</label><input type="checkbox" id="cfg-fold" checked onchange="app.updateCfg('showFoldLine',this.checked)"></div>
<div class="setting-row"><label>Lock Fold</label><input type="checkbox" id="cfg-lockFold" onchange="app.updateCfg('lockFoldLine',this.checked)"></div>
<div class="setting-row"><label>Grid</label><input type="range" id="cfg-grid" value="0.6" min="0" max="1" step="0.1" onchange="app.updateCfg('gridOpacity',this.value)"></div>
</div>
<div class="settings-section"><h3>Snap</h3>
<div class="setting-row"><label>Snap to Grid</label><input type="checkbox" id="cfg-snapGrid" onchange="app.updateCfg('snapGrid',this.checked)"></div>
<div class="setting-row"><label>Grid Size</label><input type="number" id="cfg-gridSize" value="5" min="1" max="25" step="1" onchange="app.updateCfg('gridSize',this.value)"><span style="color:#888;font-size:10px">mm</span></div>
<div class="setting-row"><label>Snap to Fold</label><input type="checkbox" id="cfg-snapFold" onchange="app.updateCfg('snapFold',this.checked)"></div>
</div>
<div class="settings-section"><h3>Visibility</h3>
<div class="setting-row"><label>Outline</label><input type="checkbox" id="cfg-showOutline" checked onchange="app.updateCfg('showOutline',this.checked)"></div>
<div class="setting-row"><label>Edge Stitches</label><input type="checkbox" id="cfg-showEdgeStitches" checked onchange="app.updateCfg('showEdgeStitches',this.checked)"></div>
<div class="setting-row"><label>Sym. Holes</label><input type="checkbox" id="cfg-showSymHoles" checked onchange="app.updateCfg('showSymmetric',this.checked)"></div>
<div class="setting-row"><label>Asym. Holes</label><input type="checkbox" id="cfg-showAsymHoles" checked onchange="app.updateCfg('showAsymmetric',this.checked)"></div>
<div class="setting-row"><label>Stitches</label><input type="checkbox" id="cfg-showStitchLines" checked onchange="app.updateCfg('showStitchLines',this.checked)"></div>
<div class="setting-row"><label>Text</label><input type="checkbox" id="cfg-showText" checked onchange="app.updateCfg('showText',this.checked)"></div>
</div>
<div class="settings-section"><h3>Print</h3>
<div class="setting-row"><label>Page Margin</label><input type="number" id="cfg-pageMargin" value="10" min="5" max="25" step="1" onchange="app.updateCfg('pageMargin',this.value)"><span style="color:#888;font-size:10px">mm</span></div>
<div class="setting-row"><label>Overlap</label><input type="number" id="cfg-pageOverlap" value="15" min="0" max="30" step="1" onchange="app.updateCfg('pageOverlap',this.value)"><span style="color:#888;font-size:10px">mm</span></div>
<div class="setting-row"><label>Reg. Marks</label><input type="checkbox" id="cfg-regMarks" checked onchange="app.updateCfg('showRegMarks',this.checked)"></div>
<div class="setting-row"><label>Center Marks</label><input type="checkbox" id="cfg-centerMarks" checked onchange="app.updateCfg('showCenterMarks',this.checked)"></div>
</div>
<div class="settings-section"><h3>Reference Image</h3>
<div class="setting-row"><button style="flex:1;padding:6px;background:#444;border:1px solid #555;color:#fff;border-radius:4px;cursor:pointer;font-size:11px" onclick="document.getElementById('ref-image-input').click()">ğŸ“· Load Image</button></div>
<input type="file" id="ref-image-input" accept="image/*" style="display:none" onchange="app.loadRefImage(event)">
<div class="setting-row"><label>Show</label><input type="checkbox" id="cfg-showRefImage" checked onchange="app.updateCfg('showRefImage',this.checked)"></div>
<div class="setting-row"><label>Opacity</label><input type="range" id="cfg-refOpacity" value="0.3" min="0.1" max="1" step="0.05" onchange="app.updateCfg('refImageOpacity',this.value)"></div>
<div class="setting-row"><label>Scale</label><input type="range" id="cfg-refScale" value="1" min="0.1" max="5" step="0.05" oninput="app.updateRefScale(this.value)"><input type="number" id="cfg-refScale-num" value="1" min="0.1" max="5" step="0.05" style="width:45px" onchange="app.updateRefScale(this.value)"></div>
<div class="setting-row"><button id="btn-calibrate" style="flex:1;padding:6px;background:#2a5a2a;border:1px solid #3a7a3a;color:#8f8;border-radius:4px;cursor:pointer;font-size:11px" onclick="app.startCalibration()">ğŸ“ Calibrate Scale</button></div>
<div class="setting-row"><button style="flex:1;padding:4px;background:#333;border:1px solid #444;color:#aaa;border-radius:4px;cursor:pointer;font-size:10px" onclick="app.clearRefImage()">âœ• Clear</button></div>
</div>
</div>

<!-- Properties Bar -->
<div id="props-bar">
<span class="sel-title" id="sel-type">Selection</span>
<div class="prop-group" id="prop-shape"><label>Shape</label><select id="sel-shape" onchange="app.changeHoleShape(this.value)"><option value="circle">Circle</option><option value="ellipse">Ellipse</option><option value="pill">Pill</option><option value="rectangle">Rectangle</option></select></div>
<div class="prop-group" id="prop-width"><label>W</label><input type="range" id="sel-width-slider" min="2" max="40" step="0.5" value="4" oninput="app.changeHoleWidth(this.value)" onchange="app.saveState()"><input type="number" id="sel-width" value="4" min="2" max="40" step="0.5" onchange="app.changeHoleWidth(this.value);app.saveState()"></div>
<div class="prop-group" id="prop-height"><label>H</label><input type="range" id="sel-height-slider" min="2" max="40" step="0.5" value="4" oninput="app.changeHoleHeight(this.value)" onchange="app.saveState()"><input type="number" id="sel-height" value="4" min="2" max="40" step="0.5" onchange="app.changeHoleHeight(this.value);app.saveState()"></div>
<div class="prop-group" id="prop-size"><label>Size</label><span id="sel-size">-</span></div>
<div class="prop-group" id="prop-text"><label>Text</label><input type="text" id="sel-text" style="width:100px;background:#333;border:1px solid #444;color:#fff;padding:3px 6px;border-radius:4px;font-size:11px" onchange="app.changeText(this.value)"></div>
<div class="prop-group" id="prop-fontsize"><label>Size</label><input type="number" id="sel-fontsize" value="12" min="6" max="72" step="1" onchange="app.changeFontSize(this.value)"></div>
<div class="prop-group" id="prop-fontstyle">
<button id="btn-bold" style="width:28px;height:24px;background:#333;border:1px solid #444;color:#fff;border-radius:3px;font-weight:bold;cursor:pointer" onclick="app.toggleBold()">B</button>
<button id="btn-italic" style="width:28px;height:24px;background:#333;border:1px solid #444;color:#fff;border-radius:3px;font-style:italic;cursor:pointer" onclick="app.toggleItalic()">I</button>
</div>
<div class="prop-group" id="prop-stitch"><label>Stitch</label><input type="checkbox" id="sel-stitch-border" onchange="app.toggleStitchBorder(this.checked)"></div>
<div class="prop-group" id="prop-margin"><label>Margin</label><input type="range" id="sel-stitch-margin-slider" min="1" max="15" step="0.5" value="3" oninput="app.changeStitchMargin(this.value)" onchange="app.saveState()"><input type="number" id="sel-stitch-margin" value="3" min="1" max="15" step="0.5" onchange="app.changeStitchMargin(this.value);app.saveState()"></div>
<div class="prop-group" id="prop-spacing"><label>Spacing</label><input type="range" id="sel-stitch-spacing-slider" min="1" max="10" step="0.5" value="3" oninput="app.changeStitchSpacing(this.value)" onchange="app.saveState()"><input type="number" id="sel-stitch-spacing" value="3" min="1" max="10" step="0.5" onchange="app.changeStitchSpacing(this.value);app.saveState()"></div>
<div class="prop-group" id="prop-create-stitch" style="display:none"><button onclick="app.createStitchFromRange()" style="background:#007AFF;color:#fff;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">+ Stitch Line</button></div>
<div class="prop-group" id="prop-es-line"><label>Line</label><input type="checkbox" id="sel-es-line" checked onchange="app.toggleEdgeStitchLine(this.checked)"></div>
<div class="prop-group" id="prop-es-holes"><label>Holes</label><input type="checkbox" id="sel-es-holes" checked onchange="app.toggleEdgeStitchHoles(this.checked)"></div>
<div class="prop-group" id="prop-es-mirror"><label>Mirror</label><input type="checkbox" id="sel-es-mirror" checked onchange="app.toggleEdgeStitchMirror(this.checked)"></div>
<div class="prop-group" id="prop-extension"><label>Extension</label><input type="checkbox" id="sel-extension" onchange="app.toggleShapeExtension(this.checked)"></div>
<div class="prop-group" id="prop-link-handles" style="display:none">
<button id="btn-link-handles" onclick="app.toggleHandleLink()" style="background:#007AFF;color:#fff;border:none;padding:4px 10px;border-radius:4px;font-size:11px;cursor:pointer">Link Handles</button>
</div>
<button class="delete-btn" onclick="app.deleteSelected()">ğŸ—‘</button>
</div>

<!-- Text Editor (inline) -->
<div id="text-editor"><input type="text" id="text-input" placeholder="Type here..." onkeydown="app.onTextKey(event)" oninput="app.onTextInput(event)"></div>

<!-- Stats Bar -->
<div id="stats">
<div class="stat"><span>Pattern:</span><span class="value" id="patternSize">-</span></div>
<div class="stat"><span>Interior:</span><span class="value" id="maxInterior">-</span></div>
<div class="stat"><span>Stitches:</span><span class="value" id="stitchCount">-</span></div>
<div class="undo-redo">
<button id="undo-btn" onclick="app.undo()" title="Undo (Ctrl+Z)" disabled>â†¶</button>
<button id="redo-btn" onclick="app.redo()" title="Redo (Ctrl+Y)" disabled>â†·</button>
</div>
</div>

<!-- Calibration Modal -->
<div id="calibration-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center">
<div style="background:#2a2a2a;padding:20px;border-radius:8px;max-width:300px;text-align:center">
<h3 style="margin:0 0 15px;color:#fff">Calibrate Scale</h3>
<p style="color:#aaa;font-size:13px;margin:0 0 15px">Enter the real-world distance between the two points (in mm):</p>
<input type="number" id="calibration-distance" value="100" min="1" style="width:100%;padding:10px;font-size:16px;border-radius:4px;border:1px solid #555;background:#333;color:#fff;text-align:center;margin-bottom:15px">
<div style="display:flex;gap:10px">
<button onclick="app.cancelCalibration()" style="flex:1;padding:10px;background:#444;border:none;border-radius:4px;color:#fff;cursor:pointer">Cancel</button>
<button onclick="app.applyCalibration()" style="flex:1;padding:10px;background:#007AFF;border:none;border-radius:4px;color:#fff;cursor:pointer">Apply</button>
</div>
</div>
</div>

<!-- Rename Modal -->
<div id="rename-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center">
<div style="background:#2a2a2a;padding:20px;border-radius:8px;max-width:300px;text-align:center">
<h3 style="margin:0 0 15px;color:#fff">Rename Project</h3>
<input type="text" id="rename-input" value="" style="width:100%;padding:10px;font-size:16px;border-radius:4px;border:1px solid #555;background:#333;color:#fff;text-align:center;margin-bottom:15px;box-sizing:border-box">
<div style="display:flex;gap:10px">
<button onclick="app.cancelRename()" style="flex:1;padding:10px;background:#444;border:none;border-radius:4px;color:#fff;cursor:pointer">Cancel</button>
<button onclick="app.applyRename()" style="flex:1;padding:10px;background:#007AFF;border:none;border-radius:4px;color:#fff;cursor:pointer">Save</button>
</div>
</div>
</div>

<!-- Publish Bar -->
<div id="publish-bar">
<span class="title">ğŸ“ Publish Mode</span>
<input type="text" id="pattern-title" placeholder="Pattern name..." value="Holster Pattern">
<span class="info">Print at 100% scale</span>
<select id="publish-view-mode" style="padding:6px 10px;border-radius:4px;border:1px solid #555;background:#333;color:#fff;font-size:12px" onchange="app.updateCfg('publishViewMode',this.value);app.draw()">
<option value="a4-pages">A4 Pages</option>
<option value="full-pattern">Full Pattern</option>
</select>
<select id="publish-layout" style="padding:6px 10px;border-radius:4px;border:1px solid #555;background:#333;color:#fff;font-size:12px;display:none" onchange="app.updateCfg('publishLayout',this.value)">
<option value="front-only">Front Only</option>
<option value="back-only">Back Only</option>
<option value="side-by-side">Side by Side</option>
<option value="stacked">Stacked</option>
<option value="overlaid">Overlaid</option>
</select>
<select id="export-format" style="padding:6px 10px;border-radius:4px;border:1px solid #555;background:#333;color:#fff;font-size:12px">
<option value="png">PNG</option>
<option value="jpg">JPG</option>
</select>
<button class="pbtn secondary" onclick="app.downloadPattern()">â¬‡ Download</button>
<button class="pbtn primary" onclick="try{window.print()}catch(e){alert('Print not available. Use Download as PNG instead.')}">ğŸ–¨ Print</button>
<button class="pbtn danger" onclick="app.togglePublish()">âœ• Exit</button>
</div>

<div id="zoom-indicator" onclick="app.resetView()" title="Click to reset view">100%</div>
<canvas id="c"></canvas>
<div id="toast-container"></div>
<script type="module" src="js/main.js"></script>
</body>
</html>
