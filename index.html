<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Leather Pattern Tool - Pre-Alpha v0.3</title>
<script src="https://cdn.jsdelivr.net/npm/clipper-lib@6.4.2/clipper.js"></script>
<script>
// Fallback ClipperLib stub if CDN fails
if (typeof ClipperLib === 'undefined') {
  console.error('ClipperLib CDN failed to load');
  
  // Show user warning on app init
  window.addEventListener('DOMContentLoaded', () => {
    const toast = document.createElement('div');
    toast.className = 'toast error';
    toast.innerHTML = 'âš ï¸ Geometry library failed to load. Some features (path offsets, boolean operations) will not work. Please refresh the page or check your internet connection.';
    toast.style.cssText = 'position:fixed;top:50px;left:50%;transform:translateX(-50%);z-index:9999;max-width:500px;padding:12px 20px;';
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 10000);
  });
  
  // Minimal stub that clearly fails
  window.ClipperLib = {
    Clipper: function() {
      this.AddPath = () => console.warn('ClipperLib not loaded - AddPath unavailable');
      this.Execute = () => { 
        console.warn('ClipperLib not loaded - Execute unavailable'); 
        return false; 
      };
    },
    ClipperOffset: function() {
      this.AddPath = () => console.warn('ClipperLib not loaded - AddPath unavailable');
      this.AddPaths = () => console.warn('ClipperLib not loaded - AddPaths unavailable');
      this.Execute = (solution) => {
        console.warn('ClipperLib not loaded - Execute unavailable');
        solution.length = 0;
      };
    },
    PolyType: { ptSubject: 0, ptClip: 1 },
    ClipType: { ctUnion: 0, ctDifference: 1, ctIntersection: 2, ctXor: 3 },
    PolyFillType: { pftNonZero: 0, pftEvenOdd: 1 },
    JoinType: { jtSquare: 0, jtRound: 1, jtMiter: 2 },
    EndType: { etClosedPolygon: 0, etClosedLine: 1, etOpenButt: 2, etOpenSquare: 3, etOpenRound: 4 }
  };
  ClipperLib.Clipper.Area = () => { console.warn('ClipperLib not loaded'); return 1000; };
  ClipperLib.Clipper.Orientation = () => { console.warn('ClipperLib not loaded'); return true; };
  ClipperLib.Clipper.SimplifyPolygon = (path) => { console.warn('ClipperLib not loaded'); return [path]; };
  ClipperLib.JS = { Clone: (obj) => JSON.parse(JSON.stringify(obj)) };
}
</script>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<!-- Left Toolbar -->
<div id="toolbar">
<button class="tool-btn active" id="tool-select" onclick="app.setMode('select')" title="Select (V)"><span class="icon"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3 L3 14 L7 10 L10 13 L16 7 Z"/></svg></span><span>Select</span></button>
<div class="tool-sep"></div>
<button class="tool-btn" id="tool-hole" onclick="app.setMode('hole')" title="Add Hole (H)"><span class="icon"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="10" cy="10" r="7"/><circle cx="10" cy="10" r="1.5" fill="currentColor"/></svg></span><span>Hole</span></button>
<button class="tool-btn" id="tool-customhole" onclick="app.setMode('customhole')" title="Custom Hole"><span class="icon"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3 L17 5 L7 15 L3 16 L4 12 Z"/><path d="M12 6 L14 8"/></svg></span><span>Custom</span></button>
<button class="tool-btn" id="tool-stitch" onclick="app.setMode('stitch')" title="Stitch Line (S)"><span class="icon"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10 L17 10" stroke-dasharray="2 2"/><path d="M16 7 L18 10 L16 13"/></svg></span><span>Stitch</span></button>
<button class="tool-btn" id="tool-shape" onclick="app.setMode('shape')" title="Shape"><span class="icon"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 3 L17 8 L14 17 L6 17 L3 8 Z"/></svg></span><span>Shape</span></button>
<button class="tool-btn" id="tool-text" onclick="app.setMode('text')" title="Add Text (T)"><span class="icon"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 5 L15 5 M10 5 L10 17 M7 17 L13 17"/></svg></span><span>Text</span></button>
<div class="tool-sep"></div>
<button class="tool-btn" onclick="app.generateMatchingCircle()" title="Circle from Edge"><span class="icon"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="10" cy="10" r="6"/><path d="M16 4 L13 7 M16 4 L16 7 M16 4 L13 4"/></svg></span><span>Circle</span></button>
<button class="tool-btn" onclick="app.addEdgeRange()" title="Add Edge Stitch Range - Places stitches along a section of the pattern edge"><span class="icon"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10 L17 10"/><circle cx="5" cy="10" r="1.5" fill="currentColor"/><circle cx="10" cy="10" r="1.5" fill="currentColor"/><circle cx="15" cy="10" r="1.5" fill="currentColor"/></svg></span><span>Edge Stitch</span></button>
<button class="tool-btn" onclick="app.addMergedEdgeRange()" title="Add Full Border Stitch - Places stitches around the entire pattern perimeter"><span class="icon"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="14" height="14"/><circle cx="3" cy="3" r="1.5" fill="currentColor"/><circle cx="17" cy="3" r="1.5" fill="currentColor"/><circle cx="17" cy="17" r="1.5" fill="currentColor"/><circle cx="3" cy="17" r="1.5" fill="currentColor"/><circle cx="10" cy="3" r="1.5" fill="currentColor"/><circle cx="17" cy="10" r="1.5" fill="currentColor"/><circle cx="10" cy="17" r="1.5" fill="currentColor"/><circle cx="3" cy="10" r="1.5" fill="currentColor"/></svg></span><span>Full Border</span></button>
<div style="flex:1"></div>
<button class="tool-btn" onclick="app.resetView()" title="Reset View"><span class="icon"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="10" cy="10" r="7"/><circle cx="10" cy="10" r="3"/><path d="M10 3 L10 5 M10 15 L10 17 M3 10 L5 10 M15 10 L17 10"/></svg></span><span>Reset</span></button>
</div>

<!-- Top Header -->
<div id="header">
<span class="title" id="project-title" onclick="app.renameProject()" title="Click to rename">Leather Pattern</span>
<span class="spacer"></span>
<div id="two-layer-actions" style="display:none;gap:8px;">
<button class="hdr-btn secondary" onclick="app.duplicateLayer('toBack')" title="Duplicate Front to Back">Copy to Back</button>
<button class="hdr-btn secondary" onclick="app.duplicateLayer('toFront')" title="Duplicate Back to Front">Copy to Front</button>
</div>
<button class="hdr-btn secondary" onclick="app.selectHolster()">Select Pattern</button>
<button class="hdr-btn secondary" onclick="app.toggleFileMenu()">ğŸ’¾ File</button>
<button class="hdr-btn primary" onclick="app.togglePublish()">ğŸ“ Publish</button>
</div>

<!-- Floating Layer Toggle Buttons -->
<div id="floating-layer-toggle" style="display:flex;">
<div id="layer-toggle" style="display:flex;">
<button class="layer-btn sym active" onclick="app.setLayer('symmetric')" title="Elements are mirrored across the fold line">Mirrored</button>
<button class="layer-btn asym" onclick="app.setLayer('asymmetric')" title="Elements appear only where placed">Single</button>
</div>
<div id="two-layer-toggle" style="display:none;">
<button class="layer-btn front active" onclick="app.switchLayer('front')">Front</button>
<button class="layer-btn back" onclick="app.switchLayer('back')">Back</button>
</div>
</div>

<!-- File Menu Dropdown -->
<div id="file-menu">
<button onclick="app.saveProject()">ğŸ’¾ Save Project</button>
<button onclick="app.loadProject()">ğŸ“‚ Open Project</button>
<input type="file" id="file-input" accept=".json" style="display:none" onchange="app.handleFileLoad(event)">
</div>

<!-- Mode Indicator -->
<div id="mode-indicator"><span class="mode-text">Mode</span><button class="mode-btn" onclick="app.finishMode()">âœ“</button><button class="mode-btn" onclick="app.cancelMode()">âœ•</button></div>

<!-- Settings Button -->
<div id="settings-btn" onclick="app.toggleSettings()">âš™</div>

<!-- Outliner Button -->
<div id="outliner-btn" onclick="app.toggleOutliner()">â˜°</div>

<!-- Outliner Panel -->
<div id="outliner-panel">
<span class="panel-title">Outliner</span>
<button class="close-btn" onclick="app.toggleOutliner()">âœ•</button>
<div id="outliner-content"></div>
</div>

<!-- Settings Panel (Non-Modal) -->
<div id="settings-panel">
<button class="close-btn" onclick="app.toggleSettings()">âœ•</button>

<!-- Settings Presets -->
<div class="settings-presets" style="padding:15px 15px 10px;border-bottom:1px solid #333">
<label style="display:block;margin-bottom:8px;font-size:12px;color:#aaa">Quick Presets:</label>
<div class="preset-buttons" style="display:flex;gap:8px">
<button data-preset="holster" onclick="app.applyPreset('holster')" title="Settings optimized for holster patterns" style="flex:1;padding:8px;background:#444;border:1px solid #555;color:#fff;border-radius:4px;cursor:pointer;font-size:11px">Holster</button>
<button data-preset="wallet" onclick="app.applyPreset('wallet')" title="Settings optimized for wallet patterns" style="flex:1;padding:8px;background:#444;border:1px solid #555;color:#fff;border-radius:4px;cursor:pointer;font-size:11px">Wallet</button>
<button data-preset="belt" onclick="app.applyPreset('belt')" title="Settings optimized for belt patterns" style="flex:1;padding:8px;background:#444;border:1px solid #555;color:#fff;border-radius:4px;cursor:pointer;font-size:11px">Belt</button>
</div>
</div>

<!-- Accordion Section: Project -->
<div class="accordion-section" data-section="project">
<div class="accordion-header" onclick="app.toggleAccordion('project')">
<span class="accordion-icon">ğŸ“‹</span>
<span class="accordion-title">Project</span>
<span class="accordion-chevron">â€º</span>
</div>
<div class="accordion-content">
<div class="setting-row"><label>Type</label><select id="cfg-projectType" onchange="app.updateCfg('projectType',this.value)"><option value="fold-over">Fold-Over</option><option value="two-layer">Two-Layer</option></select></div>
<div id="two-layer-sync" style="display:none">
<div class="setting-row"><label>Asymmetric Outline <span class="help-icon" title="When enabled, you define the full pattern outline instead of just the right half. Use this for non-symmetric patterns.">?</span></label><input type="checkbox" id="cfg-asymmetricOutline" onchange="app.updateCfg('asymmetricOutline',this.checked)"></div>
<div class="setting-row"><label>Sync Outline</label><input type="checkbox" id="cfg-syncOutline" checked onchange="app.updateCfg('syncOutline',this.checked)"></div>
<div class="setting-row"><label>Sync Edge Stitches</label><input type="checkbox" id="cfg-syncEdgeStitches" checked onchange="app.updateCfg('syncEdgeStitches',this.checked)"></div>
<div class="setting-row"><button style="flex:1;padding:6px;background:#444;border:1px solid #555;color:#fff;border-radius:4px;cursor:pointer;font-size:11px" onclick="app.resetToMaster()">â†» Reset Back to Master</button></div>
</div>
<div id="two-layer-ghost" style="display:none">
<div class="setting-row"><label>Show Other Layer</label><input type="checkbox" id="cfg-showGhostLayer" checked onchange="app.updateCfg('showGhostLayer',this.checked)"></div>
<div class="setting-row"><label>Ghost Opacity</label><input type="range" id="cfg-ghostOpacity" value="0.25" min="0.1" max="0.5" step="0.05" oninput="document.getElementById('cfg-ghostOpacity-val').textContent=this.value;app.updateCfg('ghostLayerOpacity',parseFloat(this.value))"><span id="cfg-ghostOpacity-val" style="color:#888;font-size:10px;min-width:35px;text-align:right">0.25</span></div>
<div class="setting-row"><button style="flex:1;padding:6px;background:#444;border:1px solid #555;color:#fff;border-radius:4px;cursor:pointer;font-size:11px" onclick="app.resetGhostPosition()">âŸ² Reset Ghost Position</button></div>
</div>
</div>
</div>

<!-- Accordion Section: Material -->
<div class="accordion-section expanded" data-section="material">
<div class="accordion-header" onclick="app.toggleAccordion('material')">
<span class="accordion-icon">ğŸ§µ</span>
<span class="accordion-title">Material</span>
<span class="accordion-chevron">â€º</span>
</div>
<div class="accordion-content">
<div class="setting-row"><label>Thickness</label><input type="number" id="cfg-thickness" value="3" min="1.5" max="8" step="0.5" onchange="app.updateCfg('thickness',this.value)"><span style="color:#888;font-size:10px">mm</span></div>
<div class="setting-row"><label>Color</label><input type="color" id="cfg-color" value="#b4783c" onchange="app.updateCfg('leatherColor',this.value)"></div>
</div>
</div>

<!-- Accordion Section: Display & Grid -->
<div class="accordion-section expanded" data-section="display">
<div class="accordion-header" onclick="app.toggleAccordion('display')">
<span class="accordion-icon">ğŸ‘ï¸</span>
<span class="accordion-title">Display & Grid</span>
<span class="accordion-chevron">â€º</span>
</div>
<div class="accordion-content">
<div class="setting-row"><label>Realistic Rendering</label><input type="checkbox" id="cfg-realisticRendering" checked onchange="app.updateCfg('realisticRendering',this.checked)"></div>
<div class="setting-row"><label>Cavity</label><input type="checkbox" id="cfg-cavity" checked onchange="app.updateCfg('showCavity',this.checked)"></div>
<div class="setting-row"><label>Fold Line</label><input type="checkbox" id="cfg-fold" checked onchange="app.updateCfg('showFoldLine',this.checked)"></div>
<div class="setting-row"><label>Lock Fold</label><input type="checkbox" id="cfg-lockFold" onchange="app.updateCfg('lockFoldLine',this.checked)"></div>
<div class="setting-row"><label>Grid Opacity</label><input type="range" id="cfg-grid" value="0.6" min="0" max="1" step="0.1" onchange="app.updateCfg('gridOpacity',this.value)"></div>
<div class="setting-row"><label>Snap to Grid</label><input type="checkbox" id="cfg-snapGrid" onchange="app.updateCfg('snapGrid',this.checked)"></div>
<div class="setting-row"><label>Grid Size</label><input type="number" id="cfg-gridSize" value="5" min="1" max="25" step="1" onchange="app.updateCfg('gridSize',this.value)"><span style="color:#888;font-size:10px">mm</span></div>
<div class="setting-row"><label>Snap to Fold</label><input type="checkbox" id="cfg-snapFold" onchange="app.updateCfg('snapFold',this.checked)"></div>
</div>
</div>

<!-- Accordion Section: Stitch Defaults -->
<div class="accordion-section" data-section="stitches">
<div class="accordion-header" onclick="app.toggleAccordion('stitches')">
<span class="accordion-icon">â”…</span>
<span class="accordion-title">Stitch Defaults</span>
<span class="accordion-chevron">â€º</span>
</div>
<div class="accordion-content">
<div class="setting-row"><label>Margin</label><input type="number" id="cfg-margin" value="5" min="3" max="15" step="0.5" onchange="app.updateCfg('stitchMargin',this.value)"><span style="color:#888;font-size:10px">mm</span></div>
<div class="setting-row"><label>Spacing</label><input type="number" id="cfg-spacing" value="4" min="2" max="8" step="0.5" onchange="app.updateCfg('stitchSpacing',this.value)"><span style="color:#888;font-size:10px">mm</span></div>
<div class="setting-row"><label>Hole Size</label><input type="number" id="cfg-holeSize" value="1.5" min="0.8" max="3" step="0.1" onchange="app.updateCfg('holeSize',this.value)"><span style="color:#888;font-size:10px">mm</span></div>
<div class="setting-row"><label>Mirror</label><input type="checkbox" id="cfg-mirror" checked onchange="app.updateCfg('mirrorEdgeStitches',this.checked)"></div>
</div>
</div>

<!-- Accordion Section: Hole Defaults -->
<div class="accordion-section" data-section="holes">
<div class="accordion-header" onclick="app.toggleAccordion('holes')">
<span class="accordion-icon">â—‹</span>
<span class="accordion-title">Hole Defaults</span>
<span class="accordion-chevron">â€º</span>
</div>
<div class="accordion-content">
<div class="setting-row"><label>Shape</label><select id="cfg-defShape" onchange="app.updateCfg('defaultHoleShape',this.value)"><option value="circle">Circle</option><option value="ellipse">Ellipse</option><option value="pill">Pill</option><option value="rectangle">Rectangle</option></select></div>
<div class="setting-row"><label>Width</label><input type="range" id="cfg-defW-slider" value="4" min="2" max="30" step="0.5" oninput="document.getElementById('cfg-defW').value=this.value;app.updateCfg('defaultHoleWidth',this.value)"><input type="number" id="cfg-defW" value="4" min="2" max="30" step="0.5" onchange="document.getElementById('cfg-defW-slider').value=this.value;app.updateCfg('defaultHoleWidth',this.value)"></div>
<div class="setting-row"><label>Height</label><input type="range" id="cfg-defH-slider" value="4" min="2" max="30" step="0.5" oninput="document.getElementById('cfg-defH').value=this.value;app.updateCfg('defaultHoleHeight',this.value)"><input type="number" id="cfg-defH" value="4" min="2" max="30" step="0.5" onchange="document.getElementById('cfg-defH-slider').value=this.value;app.updateCfg('defaultHoleHeight',this.value)"></div>
</div>
</div>

<!-- Accordion Section: Layer Visibility -->
<div class="accordion-section" data-section="visibility">
<div class="accordion-header" onclick="app.toggleAccordion('visibility')">
<span class="accordion-icon">ğŸ“‘</span>
<span class="accordion-title">Layer Visibility</span>
<span class="accordion-chevron">â€º</span>
</div>
<div class="accordion-content">
<div class="setting-row"><label>Outline</label><input type="checkbox" id="cfg-showOutline" checked onchange="app.updateCfg('showOutline',this.checked)"></div>
<div class="setting-row"><label>Edge Stitches</label><input type="checkbox" id="cfg-showEdgeStitches" checked onchange="app.updateCfg('showEdgeStitches',this.checked)"></div>
<div class="setting-row"><label>Mirrored Holes</label><input type="checkbox" id="cfg-showSymHoles" checked onchange="app.updateCfg('showSymmetric',this.checked)"></div>
<div class="setting-row"><label>Single Holes</label><input type="checkbox" id="cfg-showAsymHoles" checked onchange="app.updateCfg('showAsymmetric',this.checked)"></div>
<div class="setting-row"><label>Stitches</label><input type="checkbox" id="cfg-showStitchLines" checked onchange="app.updateCfg('showStitchLines',this.checked)"></div>
<div class="setting-row"><label>Text</label><input type="checkbox" id="cfg-showText" checked onchange="app.updateCfg('showText',this.checked)"></div>
</div>
</div>

<!-- Accordion Section: Print Settings -->
<div class="accordion-section" data-section="print">
<div class="accordion-header" onclick="app.toggleAccordion('print')">
<span class="accordion-icon">ğŸ–¨ï¸</span>
<span class="accordion-title">Print Settings</span>
<span class="accordion-chevron">â€º</span>
</div>
<div class="accordion-content">
<div class="setting-row"><label>Page Margin</label><input type="number" id="cfg-pageMargin" value="10" min="5" max="25" step="1" onchange="app.updateCfg('pageMargin',this.value)"><span style="color:#888;font-size:10px">mm</span></div>
<div class="setting-row"><label>Overlap</label><input type="number" id="cfg-pageOverlap" value="15" min="0" max="30" step="1" onchange="app.updateCfg('pageOverlap',this.value)"><span style="color:#888;font-size:10px">mm</span></div>
<div class="setting-row"><label>Reg. Marks</label><input type="checkbox" id="cfg-regMarks" checked onchange="app.updateCfg('showRegMarks',this.checked)"></div>
<div class="setting-row"><label>Center Marks</label><input type="checkbox" id="cfg-centerMarks" checked onchange="app.updateCfg('showCenterMarks',this.checked)"></div>
</div>
</div>

<!-- Accordion Section: Reference Image -->
<div class="accordion-section" data-section="reference">
<div class="accordion-header" onclick="app.toggleAccordion('reference')">
<span class="accordion-icon">ğŸ“·</span>
<span class="accordion-title">Reference Image</span>
<span class="accordion-chevron">â€º</span>
</div>
<div class="accordion-content">
<div class="setting-row"><button style="flex:1;padding:6px;background:#444;border:1px solid #555;color:#fff;border-radius:4px;cursor:pointer;font-size:11px" onclick="document.getElementById('ref-image-input').click()">ğŸ“· Load Image</button></div>
<input type="file" id="ref-image-input" accept="image/*" style="display:none" onchange="app.loadRefImage(event)">
<div class="setting-row"><label>Show</label><input type="checkbox" id="cfg-showRefImage" checked onchange="app.updateCfg('showRefImage',this.checked)"></div>
<div class="setting-row"><label>Opacity</label><input type="range" id="cfg-refOpacity" value="0.3" min="0.1" max="1" step="0.05" onchange="app.updateCfg('refImageOpacity',this.value)"></div>
<div class="setting-row"><label>Scale</label><input type="range" id="cfg-refScale" value="1" min="0.1" max="5" step="0.05" oninput="app.updateRefScale(this.value)"><input type="number" id="cfg-refScale-num" value="1" min="0.1" max="5" step="0.05" style="width:45px" onchange="app.updateRefScale(this.value)"></div>
<div class="setting-row"><button id="btn-calibrate" style="flex:1;padding:6px;background:#2a5a2a;border:1px solid #3a7a3a;color:#8f8;border-radius:4px;cursor:pointer;font-size:11px" onclick="app.startCalibration()">ğŸ“ Calibrate Scale</button></div>
<div class="setting-row"><button style="flex:1;padding:4px;background:#333;border:1px solid #444;color:#aaa;border-radius:4px;cursor:pointer;font-size:10px" onclick="app.clearRefImage()">âœ• Clear</button></div>
</div>
</div>

</div>

<!-- Properties Bar -->
<div id="props-bar">
<span class="sel-title" id="sel-type">Selection</span>
<div class="prop-group" id="prop-shape"><label>Shape</label><select id="sel-shape" onchange="app.changeHoleShape(this.value)"><option value="circle">Circle</option><option value="ellipse">Ellipse</option><option value="pill">Pill</option><option value="rectangle">Rectangle</option></select></div>
<div class="prop-group" id="prop-width"><label>W</label><input type="range" id="sel-width-slider" min="2" max="40" step="0.5" value="4" oninput="app.changeHoleWidth(this.value)" onchange="app.saveState()"><input type="number" id="sel-width" value="4" min="2" max="40" step="0.5" onchange="app.changeHoleWidth(this.value);app.saveState()"></div>
<div class="prop-group" id="prop-height"><label>H</label><input type="range" id="sel-height-slider" min="2" max="40" step="0.5" value="4" oninput="app.changeHoleHeight(this.value)" onchange="app.saveState()"><input type="number" id="sel-height" value="4" min="2" max="40" step="0.5" onchange="app.changeHoleHeight(this.value);app.saveState()"></div>
<div class="prop-group" id="prop-size"><label>Size</label><span id="sel-size">-</span></div>
<div class="prop-group" id="prop-text"><label>Text</label><input type="text" id="sel-text" style="width:100px;background:#333;border:1px solid #444;color:#fff;padding:3px 6px;border-radius:4px;font-size:11px" onchange="app.changeText(this.value)"></div>
<div class="prop-group" id="prop-fontsize"><label>Size</label><input type="number" id="sel-fontsize" value="12" min="6" max="72" step="1" onchange="app.changeFontSize(this.value)"></div>
<div class="prop-group" id="prop-fontstyle">
<button id="btn-bold" style="width:28px;height:24px;background:#333;border:1px solid #444;color:#fff;border-radius:3px;font-weight:bold;cursor:pointer" onclick="app.toggleBold()">B</button>
<button id="btn-italic" style="width:28px;height:24px;background:#333;border:1px solid #444;color:#fff;border-radius:3px;font-style:italic;cursor:pointer" onclick="app.toggleItalic()">I</button>
</div>
<div class="prop-group" id="prop-textstyle" style="display:none"><label>Style</label><select id="sel-textstyle" onchange="app.changeTextStyle(this.value)"><option value="normal">Normal</option><option value="subheader">Subheader</option><option value="header">Header</option></select></div>
<div class="prop-group" id="prop-listtype" style="display:none"><label>List</label><select id="sel-listtype" onchange="app.changeListType(this.value)"><option value="none">None</option><option value="bullet">Bullet</option><option value="numbered">Numbered</option><option value="lettered">Lettered</option></select></div>
<div class="prop-group" id="prop-stitch"><label>Stitch</label><input type="checkbox" id="sel-stitch-border" onchange="app.toggleStitchBorder(this.checked)"></div>
<div class="prop-group" id="prop-margin"><label>Margin</label><input type="range" id="sel-stitch-margin-slider" min="1" max="15" step="0.5" value="3" oninput="app.changeStitchMargin(this.value)" onchange="app.saveState()"><input type="number" id="sel-stitch-margin" value="3" min="1" max="15" step="0.5" onchange="app.changeStitchMargin(this.value);app.saveState()"></div>
<div class="prop-group" id="prop-spacing"><label>Spacing</label><input type="range" id="sel-stitch-spacing-slider" min="1" max="10" step="0.5" value="3" oninput="app.changeStitchSpacing(this.value)" onchange="app.saveState()"><input type="number" id="sel-stitch-spacing" value="3" min="1" max="10" step="0.5" onchange="app.changeStitchSpacing(this.value);app.saveState()"></div>
<div class="prop-group" id="prop-create-stitch" style="display:none"><button onclick="app.createStitchFromRange()" style="background:#007AFF;color:#fff;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">+ Stitch Line</button></div>
<div class="prop-group" id="prop-es-line"><label>Line</label><input type="checkbox" id="sel-es-line" checked onchange="app.toggleEdgeStitchLine(this.checked)"></div>
<div class="prop-group" id="prop-es-holes"><label>Holes</label><input type="checkbox" id="sel-es-holes" checked onchange="app.toggleEdgeStitchHoles(this.checked)"></div>
<div class="prop-group" id="prop-es-mirror"><label>Mirror</label><input type="checkbox" id="sel-es-mirror" checked onchange="app.toggleEdgeStitchMirror(this.checked)"></div>
<div class="prop-group" id="prop-extension"><label>Extension</label><input type="checkbox" id="sel-extension" onchange="app.toggleShapeExtension(this.checked)"></div>
<div class="prop-group" id="prop-mirror" style="display:none"><label>Mirror</label><input type="checkbox" id="sel-mirror" onchange="app.toggleMirror(this.checked)"></div>
<div class="prop-group" id="prop-link-handles" style="display:none">
<button id="btn-link-handles" onclick="app.toggleHandleLink()" style="background:#007AFF;color:#fff;border:none;padding:4px 10px;border-radius:4px;font-size:11px;cursor:pointer">Link Handles</button>
</div>
<button class="delete-btn" onclick="app.deleteSelected()">ğŸ—‘</button>
</div>

<!-- Inline Text Editor (contenteditable) -->
<div id="inline-text-editor" style="display:none;position:fixed;z-index:300;background:#fff;color:#000;padding:8px 12px;border:2px solid #007AFF;border-radius:4px;box-shadow:0 4px 12px rgba(0,0,0,0.3);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;font-size:14px;min-width:100px;max-width:400px;outline:none;" contenteditable="true"></div>

<!-- Stats Bar -->
<div id="stats">
<div class="stat"><span>Pattern:</span><span class="value" id="patternSize">-</span></div>
<div class="stat"><span>Interior:</span><span class="value" id="maxInterior">-</span></div>
<div class="stat"><span>Stitches:</span><span class="value" id="stitchCount">-</span></div>
<div class="undo-redo">
<button id="undo-btn" onclick="app.undo()" title="Undo (Ctrl+Z)" disabled>â†¶</button>
<button id="redo-btn" onclick="app.redo()" title="Redo (Ctrl+Y)" disabled>â†·</button>
</div>
</div>

<!-- Calibration Modal -->
<div id="calibration-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center">
<div style="background:#2a2a2a;padding:20px;border-radius:8px;max-width:300px;text-align:center">
<h3 style="margin:0 0 15px;color:#fff">Calibrate Scale</h3>
<p style="color:#aaa;font-size:13px;margin:0 0 15px">Enter the real-world distance between the two points (in mm):</p>
<input type="number" id="calibration-distance" value="100" min="1" style="width:100%;padding:10px;font-size:16px;border-radius:4px;border:1px solid #555;background:#333;color:#fff;text-align:center;margin-bottom:15px">
<div style="display:flex;gap:10px">
<button onclick="app.cancelCalibration()" style="flex:1;padding:10px;background:#444;border:none;border-radius:4px;color:#fff;cursor:pointer">Cancel</button>
<button onclick="app.applyCalibration()" style="flex:1;padding:10px;background:#007AFF;border:none;border-radius:4px;color:#fff;cursor:pointer">Apply</button>
</div>
</div>
</div>

<!-- Rename Modal -->
<div id="rename-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center">
<div style="background:#2a2a2a;padding:20px;border-radius:8px;max-width:300px;text-align:center">
<h3 style="margin:0 0 15px;color:#fff">Rename Project</h3>
<input type="text" id="rename-input" value="" style="width:100%;padding:10px;font-size:16px;border-radius:4px;border:1px solid #555;background:#333;color:#fff;text-align:center;margin-bottom:15px;box-sizing:border-box">
<div style="display:flex;gap:10px">
<button onclick="app.cancelRename()" style="flex:1;padding:10px;background:#444;border:none;border-radius:4px;color:#fff;cursor:pointer">Cancel</button>
<button onclick="app.applyRename()" style="flex:1;padding:10px;background:#007AFF;border:none;border-radius:4px;color:#fff;cursor:pointer">Save</button>
</div>
</div>
</div>

<!-- Publish Bar -->
<div id="publish-bar">
<span class="title">ğŸ“ Publish Mode</span>
<input type="text" id="pattern-title" placeholder="Pattern name..." value="Holster Pattern">
<span class="info">Print at 100% scale</span>
<select id="publish-view-mode" style="padding:6px 10px;border-radius:4px;border:1px solid #555;background:#333;color:#fff;font-size:12px" onchange="app.updateCfg('publishViewMode',this.value);app.centerPublishView();app.draw()">
<option value="a4-pages">A4 Pages</option>
<option value="full-pattern">Full Pattern</option>
</select>
<select id="publish-layout" style="padding:6px 10px;border-radius:4px;border:1px solid #555;background:#333;color:#fff;font-size:12px;display:none" onchange="app.updateCfg('publishLayout',this.value);app.centerPublishView();app.draw()">
<option value="front-only">Front Only</option>
<option value="back-only">Back Only</option>
<option value="side-by-side">Side by Side</option>
<option value="stacked">Stacked</option>
<option value="overlaid">Overlaid</option>
</select>
<select id="export-format" style="padding:6px 10px;border-radius:4px;border:1px solid #555;background:#333;color:#fff;font-size:12px">
<option value="png">PNG</option>
<option value="jpg">JPG</option>
</select>
<button class="pbtn secondary" onclick="app.downloadPattern()">â¬‡ Download</button>
<button class="pbtn primary" onclick="try{window.print()}catch(e){alert('Print not available. Use Download as PNG instead.')}">ğŸ–¨ Print</button>
<button class="pbtn danger" onclick="app.togglePublish()">âœ• Exit</button>
</div>

<div id="zoom-indicator" onclick="app.resetView()" title="Click to reset view">100%</div>
<canvas id="c"></canvas>

<!-- Loading Overlay -->
<div id="loading-overlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:9999;align-items:center;justify-content:center;flex-direction:column">
<div class="loading-spinner"></div>
<span class="loading-text" style="color:#fff;margin-top:20px;font-size:16px">Loading...</span>
</div>

<div id="toast-container"></div>
<script type="module" src="js/main.js"></script>
</body>
</html>
